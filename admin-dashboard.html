<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Openbank Balance Manipulator - Admin Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .dashboard {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #31c3df 0%, #002b45 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .content {
        padding: 40px;
      }

      .status {
        margin-bottom: 30px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 500;
      }

      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .balance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
      }

      .balance-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }

      .balance-card:hover {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .balance-card h3 {
        color: #002b45;
        margin-bottom: 15px;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .balance-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .balance-input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 1.1rem;
        transition: border-color 0.3s ease;
      }

      .balance-input:focus {
        outline: none;
        border-color: #31c3df;
      }

      .currency {
        font-size: 1.2rem;
        font-weight: 600;
        color: #6c757d;
      }

      .current-value {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #6c757d;
      }

      .actions {
        text-align: center;
        padding: 30px 0;
        border-top: 1px solid #e9ecef;
      }

      .btn {
        display: inline-block;
        padding: 15px 30px;
        margin: 0 10px;
        border: none;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #31c3df, #002b45);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(49, 195, 223, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #31c3df;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .file-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        border-left: 4px solid #31c3df;
      }

      .file-info h4 {
        color: #002b45;
        margin-bottom: 10px;
      }

      .preview-section {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #e9ecef;
      }

      .preview-section h3 {
        margin-bottom: 20px;
        color: #002b45;
      }

      .preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .preview-table th,
      .preview-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
      }

      .preview-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #002b45;
      }

      .preview-table tr:hover {
        background-color: #f8f9fa;
      }

      /* Direct Debit Management Styles */
      .direct-debit-management {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #e9ecef;
      }

      .direct-debit-management h3 {
        color: #002b45;
        margin-bottom: 20px;
        font-size: 1.5rem;
      }

      .transaction-controls {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .transaction-table-container {
        background: white;
        border-radius: 8px;
        overflow-x: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .empty-state-preview {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        margin-top: 20px;
      }

      .empty-state-box {
        max-width: 400px;
        margin: 0 auto;
      }

      .empty-state__image {
        width: 80px;
        height: 80px;
        background: url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>')
          no-repeat center;
        background-size: contain;
        margin: 0 auto 20px;
        color: #6c757d;
      }

      .empty-state__primary-text {
        font-size: 1.1rem;
        color: #6c757d;
        margin: 0;
      }

      .empty-state__primary-text--with-margin {
        margin-top: 15px;
      }

      /* Transaction Form Modal */
      .transaction-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .transaction-modal-content {
        background: white;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90%;
        overflow-y: auto;
      }

      .transaction-form {
        display: grid;
        gap: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        margin-bottom: 5px;
        font-weight: 600;
        color: #002b45;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #31c3df;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .btn-sm {
        padding: 8px 15px;
        font-size: 0.9rem;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div class="header">
        <h1>üè¶ Openbank Balance Manipulator</h1>
        <p>Admin Dashboard - Modify Balance Values</p>
      </div>

      <div class="content">
        <div class="file-info">
          <h4>üìÅ File Selection</h4>
          <div style="margin-bottom: 20px">
            <label
              for="fileSelector"
              style="
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #002b45;
              "
            >
              Select HTML File to Edit:
            </label>
            <select
              id="fileSelector"
              class="balance-input"
              style="height: 40px"
            >
              <option value="">Loading files...</option>
            </select>
          </div>
          <p id="fileDescription">
            Select a file to modify its balance values and save changes
            directly.
          </p>
        </div>

        <div id="status" class="status info" style="display: none">
          Loading current balance values...
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Processing changes...</p>
        </div>

        <div id="balanceFieldsContainer" class="balance-grid">
          <!-- Dynamic fields will be generated here -->
        </div>

        <div class="preview-section">
          <h3>üìã Changes Preview</h3>
          <table class="preview-table">
            <thead>
              <tr>
                <th>Field</th>
                <th>Current Value</th>
                <th>New Value</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="previewTableBody">
              <!-- Preview rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Direct Debit Management Section -->
        <div
          class="direct-debit-management"
          id="directDebitSection"
          style="display: none"
        >
          <h3>üè¶ Direct Debit Transaction Management</h3>
          <div class="debit-management-container">
            <!-- Transaction List -->
            <div class="transaction-manager">
              <div class="transaction-controls">
                <button
                  class="btn btn-success"
                  onclick="showAddTransactionForm()"
                >
                  ‚ûï Add New Transaction
                </button>
                <button class="btn btn-secondary" onclick="toggleEmptyState()">
                  üîÑ Toggle Empty State
                </button>
                <button class="btn btn-secondary" onclick="loadDirectDebits()">
                  üìÑ Load Current Transactions
                </button>
              </div>

              <!-- Transaction Table -->
              <div class="transaction-table-container">
                <table class="preview-table" id="directDebitTable">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Category</th>
                      <th>Description</th>
                      <th>Amount (‚Ç¨)</th>
                      <th>Balance (‚Ç¨)</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="directDebitTableBody">
                    <!-- Transaction rows will be populated here -->
                  </tbody>
                </table>
              </div>

              <!-- Empty State Preview -->
              <div
                class="empty-state-preview"
                id="emptyStatePreview"
                style="display: none"
              >
                <div class="empty-state-box">
                  <div
                    class="icon empty-state__image empty-state-search-banking"
                  ></div>
                  <div
                    class="empty-state__primary-text empty-state__primary-text--with-margin"
                  >
                    Your account currently has no transactions.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="loadCurrentValues()">
            üîÑ Refresh Current Values
          </button>
          <button class="btn btn-primary" onclick="previewChanges()">
            üëÅÔ∏è Preview Changes
          </button>
          <button class="btn btn-success" onclick="applyChanges()">
            üíæ Apply Changes
          </button>
          <button
            class="btn btn-success"
            id="applyDirectDebitsBtn"
            onclick="applyDirectDebitChanges()"
            style="display: none"
          >
            üè¶ Apply Direct Debit Changes
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentValues = {};
      let currentFileType = "";
      let availableFiles = [];
      let fieldConfigs = {};

      // Field configurations for different file types
      fieldConfigs.openbank = [
        {
          key: "accountTotalBalance",
          name: "üí∞ Account Total Balance",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "430.26",
        },
        {
          key: "individualAccountBalance",
          name: "üèõÔ∏è Individual Account Balance",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "totalSavingsBalance",
          name: "üíé Total Savings Balance",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "monthlyExpenses",
          name: "üìä Monthly Expenses (Agosto)",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "savingsInvestmentsTotal",
          name: "üìà Savings & Investments Total",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "totalLending",
          name: "üí≥ Total Lending",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "cardLastDigits",
          name: "üí≥ Card Last 4 Digits (Global)",
          type: "text",
          placeholder: "...2150",
        },
        {
          key: "avatarName",
          name: "üåê User Display Name (ALL HTML Files)",
          type: "text",
          placeholder: "Alfonso",
        },
      ];

      fieldConfigs.directDebits = [
        {
          key: "accountsBalanceAmount",
          name: "üí∞ Balance in your accounts",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "cardLastDigits",
          name: "üí≥ Card Last 4 Digits",
          type: "text",
          placeholder: "...2150",
        },
        {
          key: "availableAmount",
          name: "üíµ Available Amount",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "availableCurrency",
          name: "üí± Available Currency",
          type: "text",
          placeholder: "‚Ç¨",
        },
        {
          key: "avatarName",
          name: "üåê User Display Name (ALL HTML Files)",
          type: "text",
          placeholder: "Alfonso",
        },
      ];

      // Direct Debit Management Configuration
      fieldConfigs.directDebitManagement = {
        emptyStateConfig: {
          showEmpty: true,
          emptyMessage: "Your account currently has no transactions.",
          className:
            "empty-state__primary-text empty-state__primary-text--with-margin",
        },
        transactionFields: [
          { name: "date", label: "Date", type: "date", required: true },
          {
            name: "category",
            label: "Category",
            type: "select",
            required: true,
            options: [
              {
                value: "category_9",
                label: "Purchases",
                icon: "https://www.openbank.es/assets/static/images/categories/icons/category_9.png",
              },
              {
                value: "category_12",
                label: "Commissions",
                icon: "https://www.openbank.es/assets/static/images/categories/icons/category_12.png",
              },
              {
                value: "category_1",
                label: "Transfers",
                icon: "https://www.openbank.es/assets/static/images/categories/icons/category_1.png",
              },
              {
                value: "category_5",
                label: "Subscriptions",
                icon: "https://www.openbank.es/assets/static/images/categories/icons/category_5.png",
              },
            ],
          },
          {
            name: "description",
            label: "Description",
            type: "text",
            required: true,
            maxLength: 150,
          },
          {
            name: "amount",
            label: "Amount",
            type: "number",
            required: true,
            step: "0.01",
          },
          {
            name: "balance",
            label: "Balance After",
            type: "number",
            required: true,
            step: "0.01",
          },
        ],
      };

      fieldConfigs.cards = [
        {
          key: "cardLastDigits",
          name: "üí≥ Card Last 4 Digits",
          type: "text",
          placeholder: "1704",
        },
        {
          key: "avatarName",
          name: "üåê User Display Name (ALL HTML Files)",
          type: "text",
          placeholder: "Alfonso",
        },
      ];

      fieldConfigs.transfers = [
        {
          key: "accountBalance",
          name: "üí∞ Account Balance (Global)",
          type: "number",
          currency: "‚Ç¨",
          placeholder: "0.00",
        },
        {
          key: "cardLastDigits",
          name: "üí≥ Card Last 4 Digits (Global)",
          type: "text",
          placeholder: "...2150",
        },
        {
          key: "avatarName",
          name: "üåê User Display Name (ALL HTML Files)",
          type: "text",
          placeholder: "Alfonso",
        },
      ];

      // Load list of available files
      async function loadAvailableFiles() {
        try {
          const response = await fetch("/api/files");
          const data = await response.json();

          if (data.success) {
            availableFiles = data.files;
            populateFileSelector();
          } else {
            console.error("Error loading files:", data.error);
          }
        } catch (error) {
          console.error("Error loading files:", error);
        }
      }

      // Populate the file selector dropdown
      function populateFileSelector() {
        const selector = document.getElementById("fileSelector");
        selector.innerHTML = '<option value="">Select a file...</option>';

        availableFiles.forEach((file) => {
          const option = document.createElement("option");
          option.value = file.key;
          option.textContent = file.displayName;
          selector.appendChild(option);
        });
      }

      // Handle file selection change
      function onFileSelectionChange() {
        const selector = document.getElementById("fileSelector");
        const selectedFileType = selector.value;

        if (selectedFileType) {
          currentFileType = selectedFileType;
          generateFieldsForFileType(selectedFileType);
          loadCurrentValues();
          updateFileDescription(selectedFileType);

          // Show direct debit management for direct debit files
          const directDebitSection =
            document.getElementById("directDebitSection");
          const applyDirectDebitsBtn = document.getElementById(
            "applyDirectDebitsBtn"
          );
          if (
            selectedFileType === "directDebits" ||
            selectedFileType.includes("direct-debit")
          ) {
            directDebitSection.style.display = "block";
            applyDirectDebitsBtn.style.display = "inline-block";
            loadDirectDebits();
          } else {
            directDebitSection.style.display = "none";
            applyDirectDebitsBtn.style.display = "none";
          }
        } else {
          currentFileType = "";
          document.getElementById("balanceFieldsContainer").innerHTML = "";
          document.getElementById("fileDescription").textContent =
            "Select a file to modify its balance values and save changes directly.";
          document.getElementById("directDebitSection").style.display = "none";
        }
      }

      // Update file description
      function updateFileDescription(fileType) {
        const file = availableFiles.find((f) => f.key === fileType);
        if (file) {
          document.getElementById(
            "fileDescription"
          ).textContent = `Currently editing: ${file.displayName} (${file.filename})`;
        }
      }

      // Generate dynamic fields based on file type
      function generateFieldsForFileType(fileType) {
        const container = document.getElementById("balanceFieldsContainer");
        const fields = fieldConfigs[fileType] || [];

        container.innerHTML = "";

        fields.forEach((field) => {
          const card = document.createElement("div");
          card.className = "balance-card";

          let inputHtml = "";
          if (field.type === "number") {
            inputHtml = `
              <div class="balance-input-group">
                <input
                  type="number"
                  step="0.01"
                  class="balance-input"
                  id="${field.key}"
                  placeholder="${field.placeholder}"
                />
                ${
                  field.currency
                    ? `<span class="currency">${field.currency}</span>`
                    : ""
                }
              </div>`;
          } else {
            inputHtml = `
              <div class="balance-input-group">
                <input
                  type="text"
                  class="balance-input"
                  id="${field.key}"
                  placeholder="${field.placeholder}"
                  maxlength="50"
                />
              </div>`;
          }

          card.innerHTML = `
            <h3>${field.name}</h3>
            ${inputHtml}
            <div class="current-value" id="current${field.key}">
              Current: Loading...
            </div>
          `;

          container.appendChild(card);
        });

        // Add event listeners to new fields
        addFieldEventListeners();
      }

      // Add event listeners to dynamic fields
      function addFieldEventListeners() {
        document.querySelectorAll(".balance-input").forEach((input) => {
          input.addEventListener("input", previewChanges);
        });
      }

      // Load current balance values from the HTML file
      async function loadCurrentValues() {
        if (!currentFileType) {
          showStatus("Please select a file first", "error");
          return;
        }

        try {
          showStatus("Loading current balance values...", "info");

          const response = await fetch(
            `/api/current-balances?fileType=${currentFileType}`
          );
          const data = await response.json();

          if (data.success) {
            currentValues = data.balances;
            updateCurrentValueDisplay();
            showStatus("Current values loaded successfully!", "success");
          } else {
            showStatus("Error loading current values: " + data.error, "error");
          }
        } catch (error) {
          showStatus("Error loading current values: " + error.message, "error");
        }
      }

      // Update the display of current values
      function updateCurrentValueDisplay() {
        const fields = fieldConfigs[currentFileType] || [];

        fields.forEach((field) => {
          const currentElement = document.getElementById(`current${field.key}`);
          if (currentElement) {
            const value = currentValues[field.key] || field.placeholder;
            const formattedValue =
              field.currency && field.type === "number"
                ? `Current: ${value} ${field.currency}`
                : `Current: ${value}`;
            currentElement.textContent = formattedValue;
          }
        });
      }

      // Preview changes before applying
      function previewChanges() {
        if (!currentFileType) {
          return;
        }

        const newValues = getNewValues();
        const previewTableBody = document.getElementById("previewTableBody");
        previewTableBody.innerHTML = "";

        const fields = fieldConfigs[currentFileType] || [];

        fields.forEach((field) => {
          const row = document.createElement("tr");
          const currentVal = currentValues[field.key] || field.placeholder;
          const newVal = newValues[field.key] || currentVal;
          const hasChanged = currentVal !== newVal;

          // Format display values
          let displayCurrentVal, displayNewVal;
          if (field.currency && field.type === "number") {
            displayCurrentVal = `${currentVal} ${field.currency}`;
            displayNewVal = `${newVal} ${field.currency}`;
          } else {
            displayCurrentVal = currentVal;
            displayNewVal = newVal;
          }

          row.innerHTML = `
                     <td>${field.name}</td>
                     <td>${displayCurrentVal}</td>
                     <td>${displayNewVal}</td>
                     <td style="color: ${hasChanged ? "#28a745" : "#6c757d"}">
                         ${hasChanged ? "‚úÖ Will Change" : "‚è∏Ô∏è No Change"}
                     </td>
                 `;
          previewTableBody.appendChild(row);
        });

        showStatus(
          'Preview updated! Review changes below and click "Apply Changes" to save.',
          "info"
        );
      }

      // Get new values from input fields
      function getNewValues() {
        const newValues = {};
        const fields = fieldConfigs[currentFileType] || [];

        fields.forEach((field) => {
          const element = document.getElementById(field.key);
          if (element) {
            newValues[field.key] = element.value || currentValues[field.key];
          }
        });

        return newValues;
      }

      // Apply changes to the HTML file
      async function applyChanges() {
        if (!currentFileType) {
          showStatus("Please select a file first", "error");
          return;
        }

        const newValues = getNewValues();
        const file = availableFiles.find((f) => f.key === currentFileType);
        const fileName = file ? file.filename : "the selected file";

        // Show confirmation
        if (
          !confirm(
            `Are you sure you want to apply these changes? This will modify the ${fileName} file.`
          )
        ) {
          return;
        }

        try {
          showLoading(true);
          showStatus("Applying changes...", "info");

          const response = await fetch("/api/update-balances", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              balances: newValues,
              fileType: currentFileType,
            }),
          });

          const data = await response.json();
          showLoading(false);

          if (data.success) {
            showStatus(
              `‚úÖ Changes applied successfully! The ${fileName} file has been updated.`,
              "success"
            );
            // Reload current values to reflect changes
            setTimeout(() => {
              loadCurrentValues();
            }, 1000);
          } else {
            showStatus("‚ùå Error applying changes: " + data.error, "error");
          }
        } catch (error) {
          showLoading(false);
          showStatus("‚ùå Error applying changes: " + error.message, "error");
        }
      }

      // Show status message
      function showStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        statusDiv.style.display = "block";
      }

      // Show/hide loading spinner
      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        loadAvailableFiles();

        // Add event listener for file selector
        document
          .getElementById("fileSelector")
          .addEventListener("change", onFileSelectionChange);
      });

      // Direct Debit Management Functions
      let currentTransactions = [];
      let currentTransactionId = null;
      let isEmptyState = false;

      // Load current direct debit transactions
      async function loadDirectDebits() {
        try {
          showStatus("Loading current transactions...", "info");

          const response = await fetch(
            `/api/direct-debits?fileType=${currentFileType}`
          );
          const data = await response.json();

          if (data.success) {
            currentTransactions = data.transactions || [];
            renderTransactionTable();
            showStatus(
              `Loaded ${currentTransactions.length} transactions`,
              "success"
            );
          } else {
            showStatus("Error loading transactions: " + data.error, "error");
          }
        } catch (error) {
          showStatus("Error loading transactions: " + error.message, "error");
        }
      }

      // Render transaction table
      function renderTransactionTable() {
        const tbody = document.getElementById("directDebitTableBody");
        const emptyState = document.getElementById("emptyStatePreview");
        const tableContainer = document.querySelector(
          ".transaction-table-container"
        );

        if (isEmptyState || currentTransactions.length === 0) {
          tbody.innerHTML = "";
          tableContainer.style.display = "none";
          emptyState.style.display = "block";
          return;
        }

        tableContainer.style.display = "block";
        emptyState.style.display = "none";

        tbody.innerHTML = currentTransactions
          .map(
            (transaction, index) => `
          <tr>
            <td>${formatDate(transaction.date)}</td>
            <td>
              <img src="${getCategoryIcon(
                transaction.category
              )}" alt="category" style="width: 20px; height: 20px;">
              ${getCategoryLabel(transaction.category)}
            </td>
            <td title="${transaction.description}">${truncateText(
              transaction.description,
              50
            )}</td>
            <td style="color: ${
              transaction.amount < 0 ? "#dc3545" : "#28a745"
            };">${transaction.amount.toFixed(2)}</td>
            <td>${transaction.balance.toFixed(2)}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-secondary" onclick="editTransaction(${index})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${index})">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Toggle between empty state and transaction view
      function toggleEmptyState() {
        isEmptyState = !isEmptyState;
        renderTransactionTable();

        const statusText = isEmptyState
          ? "Showing empty state view"
          : "Showing transaction view";
        showStatus(statusText, "info");
      }

      // Show add transaction form
      function showAddTransactionForm() {
        currentTransactionId = null;
        showTransactionModal();
      }

      // Show edit transaction form
      function editTransaction(index) {
        currentTransactionId = index;
        const transaction = currentTransactions[index];
        showTransactionModal(transaction);
      }

      // Delete transaction
      function deleteTransaction(index) {
        if (confirm("Are you sure you want to delete this transaction?")) {
          currentTransactions.splice(index, 1);
          renderTransactionTable();
          showStatus("Transaction deleted", "success");
        }
      }

      // Show transaction modal
      function showTransactionModal(transaction = null) {
        const isEdit = transaction !== null;
        const modalHtml = `
          <div class="transaction-modal" id="transactionModal">
            <div class="transaction-modal-content">
              <h3>${isEdit ? "Edit Transaction" : "Add New Transaction"}</h3>
              <form class="transaction-form" onsubmit="saveTransaction(event)">
                <div class="form-group">
                  <label for="transactionDate">Date *</label>
                  <input type="date" id="transactionDate" required 
                         value="${
                           transaction ? transaction.date.split("T")[0] : ""
                         }">
                </div>
                
                <div class="form-group">
                  <label for="transactionCategory">Category *</label>
                  <select id="transactionCategory" required>
                    ${fieldConfigs.directDebitManagement.transactionFields[1].options
                      .map(
                        (option) => `
                      <option value="${option.value}" ${
                          transaction && transaction.category === option.value
                            ? "selected"
                            : ""
                        }>
                        ${option.label}
                      </option>
                    `
                      )
                      .join("")}
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="transactionDescription">Description *</label>
                  <textarea id="transactionDescription" required maxlength="150" rows="3"
                            placeholder="Enter transaction description...">${
                              transaction ? transaction.description : ""
                            }</textarea>
                </div>
                
                <div class="form-group">
                  <label for="transactionAmount">Amount (‚Ç¨) *</label>
                  <input type="number" id="transactionAmount" step="0.01" required
                         value="${
                           transaction ? transaction.amount : ""
                         }" placeholder="-50.00">
                </div>
                
                <div class="form-group">
                  <label for="transactionBalance">Balance After (‚Ç¨) *</label>
                  <input type="number" id="transactionBalance" step="0.01" required
                         value="${
                           transaction ? transaction.balance : ""
                         }" placeholder="1234.56">
                </div>
                
                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">Cancel</button>
                  <button type="submit" class="btn btn-success">${
                    isEdit ? "Update" : "Add"
                  } Transaction</button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHtml);
      }

      // Save transaction
      function saveTransaction(event) {
        event.preventDefault();

        const transactionData = {
          date: document.getElementById("transactionDate").value + "T12:00:00Z",
          category: document.getElementById("transactionCategory").value,
          description: document
            .getElementById("transactionDescription")
            .value.trim(),
          amount: parseFloat(
            document.getElementById("transactionAmount").value
          ),
          balance: parseFloat(
            document.getElementById("transactionBalance").value
          ),
          id:
            currentTransactionId !== null
              ? currentTransactions[currentTransactionId].id
              : `txn_${Date.now()}`,
        };

        if (currentTransactionId !== null) {
          // Update existing transaction
          currentTransactions[currentTransactionId] = transactionData;
          showStatus("Transaction updated successfully", "success");
        } else {
          // Add new transaction
          currentTransactions.unshift(transactionData); // Add to beginning
          showStatus("Transaction added successfully", "success");
        }

        renderTransactionTable();
        closeTransactionModal();
      }

      // Close transaction modal
      function closeTransactionModal() {
        const modal = document.getElementById("transactionModal");
        if (modal) {
          modal.remove();
        }
      }

      // Apply direct debit changes to HTML file
      async function applyDirectDebitChanges() {
        if (!currentFileType) {
          showStatus("Please select a file first", "error");
          return;
        }

        try {
          showLoading(true);
          showStatus("Applying direct debit changes...", "info");

          const response = await fetch("/api/update-direct-debits", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              transactions: currentTransactions,
              fileType: currentFileType,
              showEmptyState: isEmptyState,
            }),
          });

          const data = await response.json();
          showLoading(false);

          if (data.success) {
            showStatus("Direct debit changes applied successfully!", "success");
          } else {
            showStatus("Error applying changes: " + data.error, "error");
          }
        } catch (error) {
          showLoading(false);
          showStatus("Error applying changes: " + error.message, "error");
        }
      }

      // Utility functions
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      function getCategoryIcon(category) {
        const config =
          fieldConfigs.directDebitManagement.transactionFields[1].options;
        const categoryData = config.find((opt) => opt.value === category);
        return categoryData ? categoryData.icon : config[0].icon;
      }

      function getCategoryLabel(category) {
        const config =
          fieldConfigs.directDebitManagement.transactionFields[1].options;
        const categoryData = config.find((opt) => opt.value === category);
        return categoryData ? categoryData.label : "Unknown";
      }

      function truncateText(text, maxLength) {
        return text.length > maxLength
          ? text.substring(0, maxLength) + "..."
          : text;
      }

      // Note: Event listeners for fields are added dynamically in addFieldEventListeners()
    </script>
  </body>
</html>
